;
;
;
; extensions.conf
;
;
;

[globals]

; 2020
PSTN=DAHDI/1
Islas=DAHDI/3
QueueTO=120		; Timeout a ser usado nas filas de atendimento
			; depois desse tempo as chamadas vao para o voice mail

QueueOptions = HhKknTt
DialOptions = HhKknTt
;
; tempos de discagem
;
DAHDIDIALTIMEOUT=60
SIPDialTO=60
IAXDIALTIMEOUT=60

MBOXFONE=4001
MBOXISLAS=4002

[general]
autofalltrough=yes
callcounter=yes

;
; Extensoes de teste
;

exten => 200,1,Set(CHANNEL(language)=br)
exten => 200,n,DateTime(now,,AHBdY)
exten => 200,n,MusicOnHold()
exten => 200,n,Wait(3)
exten => 200,n,Answer()
exten => 200,n,Playback(hello-world)
exten => 200,n,SayDigits(${EXTEN})
exten => 200,n,Hangup()

exten => 201,1,Goto(TestMenu,start,1)

exten => 202,1,NoOp(Teste 202)
	same => n,Playback(hello-world)
	same => n,Hangup()





;============================================================

exten	=> 300,1,NoOp()
	same => n,Set(MSGNUM=${DB(arfn/count)})
	same => n,GotoIf($[${ISNULL(${MSGNUM})}]?:continue)
	same => n,Verbose(2,Vai comecar a contar)
	same => n,Set(DB(arfn/count)=1)
	same => n,Goto(1)
	same => n(continue),NoOp()
	same => n,Verbose(2,[ ${MSGNUM} ])
	same => n,Set(MSGNUM=$[${MSGNUM} + 1])
	same => n,Playback(silence/1)
	same => n,SayNumber(${MSGNUM})
	same => n,Set(DB(arfn/count)=${MSGNUM})
	same => n,Playback(silence/1&vm-intro)
	same => n,Verbose(2,Gravando prompt${MSGNUM}.wav)
	same => n,Record(prompt${MSGNUM}.wav)
	same => n,Wait(2)
	same => n,Playback(prompt${MSGNUM})
	same => n,Goto(1)

exten		=> 301,1,NoOp()
	same	=> n,Wait(1)
	same	=> n,Read(PNUM,vm-intro,3)
	same	=> n,Verbose(2,Prompt: [prompt${PNUM}.wav])
	same	=> n,Set(x=${STAT(f,/var/lib/asterisk/sounds/prompt${PNUM}.wav)})
	same 	=> n,GotoIf($[${x}=1]?existe:naoexiste)
	same 	=> n(existe),SayDigits(${PNUM})
	same 	=> n,Playback(prompt${PNUM})
	same 	=> n,Goto(1)
	same	=> n(naoexiste),Playback(silence/1&enum-lookup-failed)
	same 	=> n,Goto(1)
	;same	=> n


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;



;============================================================


;========================================================= from-internal
[from-internal]

include => RamaisISLAS
include => RotaCelular
include => RotaLocal

exten => 55,1,Answer()
 same => n, Verbose(2,Queue Options are '${QueueOptions}')
 same => n, Playback(hello-world)
 same => n, Hangup()

;
; 	501:	Entra nas filas Fixo e Interfone
;	
exten => 501,1,Verbose(2,Via ${EXTEN}: Canal ${CHANNEL(channeltype)} entrando em ${CHANNEL(peername)})
	same => n,GotoIf($[${CHANNEL(channeltype)} = DAHDI]?canal_DAHDI,1)
	same => n,GotoIf($[${CHANNEL(channeltype)} = PJSIP]?canal_PJSIP,1)
	same => n,GotoIf($[${CHANNEL(channeltype)} = IAX2]?canal_IAX,1)
	same => n,Verbose(3,Canal nao e DAHDI nem PJSIP nem IAX)
	same => n,Hangup()
	
exten => canal_IAX,1,Verbose(3,IAX)
	same => n,AddQueueMember(Fixo,${CHANNEL(channeltype)}/${CHANNEL(peername)})
	same => n,AddQueueMember(Interfone,${CHANNEL(channeltype)}/${CHANNEL(peername)})

        same => n,GotoIf($[${AQMSTATUS} = ADDED]?:a)
	same => n,Verbose(3,Adicionado ==> OK)
	same => n,Playback(silence/1&agent-loginok);
	same => n,Hangup()

        same => n(a),GotoIf($[${AQMSTATUS} = MEMBERALREADY]?:continue)
	same => n,Verbose(3,Ja atendendo ==> OK)
	same => n,Playback(silence/1&agent-alreadyon);

	same => n(continue),Hangup()
	
exten => canal_PJSIP,1,Verbose(3,PJSIP)
	same => n,AddQueueMember(Fixo,${CHANNEL(channeltype)}/${CHANNEL(peername)})
	same => n,AddQueueMember(Interfone,${CHANNEL(channeltype)}/${CHANNEL(peername)})
        same => n,GotoIf($[${AQMSTATUS} = ADDED]?:a)

	same => n,Verbose(3,Adicionado ==> OK)
	same => n,Playback(silence/1&agent-loginok);
	same => n,Hangup()

        same => n(a),GotoIf($[${AQMSTATUS} = MEMBERALREADY]?:continue)
	same => n,Verbose(3,Ja atendendo ==> OK)
	same => n,Playback(silence/1&agent-alreadyon);

	same => n(continue),Hangup()
	
exten => canal_DAHDI,1,Verbose(3,DAHDI)
	same => n,AddQueueMember(Fixo,${CHANNEL(channeltype)}/${CHANNEL(peername)})
	same => n,AddQueueMember(Interfone,${CHANNEL(channeltype)}/${CHANNEL(peername)})
        same => n,GotoIf($[${AQMSTATUS} = ADDED]?:a)

	same => n,Verbose(3,Adicionado ==> OK)
	same => n,Playback(silence/1&agent-loginok);
	same => n,Hangup()

        same => n(a),GotoIf($[${AQMSTATUS} = MEMBERALREADY]?:continue)
	same => n,Verbose(3,Ja atendendo ==> OK)
	same => n,Playback(silence/1&agent-alreadyon);

	same => n(continue),Hangup()

;
; 	502:	Sai da fila
;	

exten => 502,1,	Verbose(2,${EXTEN}:==> Removendo ${CHANNEL(name)} ${CHANNEL(channeltype)}/${CHANNEL(peername)} da fila)
	same => n,GotoIf($[${CHANNEL(channeltype)} = DAHDI]?canal_DAHDI_R,1)
	same => n,GotoIf($[${CHANNEL(channeltype)} = PJSIP]?canal_SIP_R,1)
	same => n,GotoIf($[${CHANNEL(channeltype)} = IAX2]?canal_IAX_R,1)
	same => n,Verbose(3,Canal nao e DAHDI nem PJSIP nem IAX)
	same => n,Hangup()
	
exten => canal_IAX_R,1,Verbose(2,IAX Remove)
	same => n,RemoveQueueMember(Fixo,${CHANNEL(channeltype)}/${CHANNEL(peername)})
	same => n,RemoveQueueMember(Interfone,${CHANNEL(channeltype)}/${CHANNEL(peername)})

        same => n,GotoIf($[${RQMSTATUS} = REMOVED]?:continue)
	same => n,Verbose(3,Agente REMOVIDO ==> OK)
	same => n,Playback(silence/1&agent-loggedoff);

	same => n(continue),Hangup()
	
exten => canal_PJSIP_R,1,Verbose(2,PJSIP Remove)
	same => n,RemoveQueueMember(Fixo,${CHANNEL(channeltype)}/${CHANNEL(peername)})
	same => n,RemoveQueueMember(Interfone,${CHANNEL(channeltype)}/${CHANNEL(peername)})
	
        same => n,GotoIf($[${RQMSTATUS} = REMOVED]?:continue)
	same => n,Verbose(3,Agente REMOVIDO ==> OK)
	same => n,Playback(silence/1&agent-loggedoff);

	same => n(continue),Hangup()

exten => canal_DAHDI_R,1,Verbose(2,DAHDI Remove)
	same => n,RemoveQueueMember(Fixo,${CHANNEL(channeltype)}/${CHANNEL(peername)})
	same => n,RemoveQueueMember(Interfone,${CHANNEL(channeltype)}/${CHANNEL(peername)})

        same => n,GotoIf($[${RQMSTATUS} = REMOVED]?:continue)
	same => n,Verbose(3,Agente REMOVIDO ==> OK)
	same => n,Playback(silence/1&agent-loggedoff);

	same => n(continue),Hangup()

exten => 555,hint,555
exten => 555,1,NoOp(555: Acesso ao Correio de VOZ)
    same => n,Verbose(3,Acesso ao Correio de Voz)
    same => n,VoiceMailMain()
    same => n,Hangup()

exten => 664,1,Verbose(2,[${EXTEN}])
	same => n,Playback(hello-world)
	same => n,Playback(silence/1)
	same => n,Playback(agent-loginok)
	same => n,Playback(silence/1&hello-world)
	same => n,Playback(silence/1&agent-loginok)
	same => n,Hangup()

exten => 665,1,Verbose(2,[${EXTEN}])
	same 	=> n,Playback(silence/1&prompt53)
	same 	=> n,Verbose(2,testa se o servidor esta ligado)
	same 	=> n,System(/etc/asterisk/teste.sh)
	same 	=> n,Verbose(2,Retorno do script: ${SYSTEMSTATUS})
	same	=> n,GotoIf($[${SYSTEMSTATUS}=SUCCESS]?sucesso:falha)
	same 	=> n(sucesso),Playback(silence/1&prompt36)
	same 	=> n,Verbose(2,Servidor ligado)
	same 	=> n,Hangup()
	; desligado
	same => n(falha),NoOp()
	same => n,Playback(silence/1&prompt37)
	same => n,Verbose(2,servidor NAO esta ligado)
	;
	; 	Tecle 1 para ligar o servidor
	same	=> n,Read(ASW,prompt42&prompt54&beep,4)
	same	=> n,Verbose(2,Leu: [${ASW}])
	same 	=> n,GotoIf($[${ASW}=1]?liga:naoliga)
	same	=> n(liga),NoOp()
	same 	=> n,Verbose(2,Vai rodar server-on)
	same 	=> n,System(/etc/asterisk/server-on.sh)
	same 	=> n,Verbose(2,Retorno de server-on: ${SYSTEMSTATUS})
	same	=> n,GotoIf($[${SYSTEMSTATUS}=SUCCESS]?script-ok:script-error)
	same	=> n(script-ok),NoOp()
	same 	=> n,Verbose(2, server-on ok. Aguarde)
	same 	=> n,Playback(silence/1&prompt47)
	same 	=> n,Hangup()
	same	=> n(script-error),NoOp()
	same 	=> n,Verbose(2, server-on falhou. Aguarde)
	same 	=> n,Playback(silence/1&prompt50)
	same 	=> n,Hangup()

exten => 666,1,Verbose(2,[${EXTEN}])
 same => n,Verbose(2,Ligando o servidor de Midia)
 same => n,System(/etc/asterisk/Plex-on.sh)
 same => n,Verbose(2,Retorno do script: ${SYSTEMSTATUS})
 same => n,Playback(silence/1)
 same => n,Hangup()

;
; Ramais Internos: 4001 a 4004
;
exten => 4001,1,GoSub(subRamaisInternos,start,1(4001,DAHDI/8,30))
exten => 4002,1,GoSub(subRamaisInternos,start,1(4002,DAHDI/7,30))
exten => 4003,1,GoSub(subRamaisInternos,start,1(4003,DAHDI/6,30))
exten => 4004,1,GoSub(subRamaisInternos,start,1(4004,DAHDI/5,30))

;
; 2020 SIP extensions 52XXX
;

exten => 52000,1,NoOp(TIP 100 52000)
    same => n,Verbose(3, VOIP Phone)
    same => n,Dial(PJSIP/52000,${SIPDialTO},${DialOptions})
    same => n,Hangup()

exten => 52006,1,NoOp(DSK-1910 SIP 52006)
    same => n,Verbose(3, Plex Server 52006)
    same => n,Dial(PJSIP/52006,${SIPDialTO},${DialOptions})
    same => n,Hangup()

exten => 52007,1,NoOp(HP8000 SIP 52007)
    same => n,Verbose(3, HP8000 52007)
    same => n,Dial(PJSIP/52007,${SIPDialTO},${DialOptions})
    same => n,Hangup()

exten => 52008,1,NoOp(Infoway SIP 52008)
    same => n,Verbose(3, Infoway 52008)
    same => n,Dial(PJSIP/52008,${SIPDialTO},${DialOptions})
    same => n,Hangup()

exten => 52009,1,NoOp( dv7 SIP 52009)
    same => n,Verbose(3, dv7 52009)
    same => n,Dial(PJSIP/52009,${SIPDialTO},${DialOptions})
    same => n,Hangup()

;
; 2020 IAX2 extensions 6XXXX
;

exten => 60000,1,NoOp(Celular do Antonio ${EXTEN})
 same => n,Verbose(3,ARFN via IAX2 ${EXTEN})
 same => n,Wait(1)
 same => n,Dial(IAX2/${EXTEN},30)
 same => n,Hangup()

;=================================================================== PBX
[PBX]
;
; linha 2 ligada ao PABX do predio no canal 3 da placa
;
exten => s,1,Verbose(3,==>> I N T E R F O N E )
    same => n,Set(CALLERID(name)=Interfone )
    same => n,Set(CALLERID(num)=XXXX)
    same => n,Progress()
    same => n,MusicOnHold(,8)
    same => n,Queue(Interfone,${QueueOptions},,,${QueueTO});
    same => n,VoiceMail(${MBOXISLAS}@default,u)
    same => n,Hangup()

;================================================================== PSTN
[PSTN]
;
; linha 1 PSTN VIVO
;
exten => s,1,NoOp(FIXO)
    same => n,Verbose(3,Linha Externa)
    same => n,Verbose(3,Chamada de [${CALLERID(all)}])
    same => n,Verbose(3,Name <${CALLERID(name)}>)
    same => n,Verbose(3,Num  <${CALLERID(num)}>)
    same => n,GotoIf($[${ISNULL(${CALLERID(name)})}]?:continue)
; 	se nao veio o nome, troca por "telefone"
    same => n,Set(CALLERID(name)=Telefone)
    ;same => n,Progress()
    ;same => n,MusicOnHold(,8)
    same => n(continue),Queue(Fixo,${QueueOptions},,,${QueueTO});
    same => n,VoiceMail(${MBOXFONE}@default,u)
    same => n,Hangup()

;================================================================ Queues
[Queues]
exten => 7001,1,Verbose(3,${CALLERID(all)} entrando na fila "Interfone")
    same => n,Queue(Interfone,${QueueOptions},,,${QueueTO})
    same => n,VoiceMail(${MBOXISLAS}@default,u)
    same => n,Hangup()

exten => 7002,1,Verbose(3,${CALLERID(all)} Entrando na fila "Fixo")
    same => n,Queue(Fixo,${QueueOptions},,,${QueueTO})
    same => n,VoiceMail(${MBOXFONE}@default,u)
    same => n,Hangup()

;============================================================= RamaisIAX
[RamaisIAX]

exten => 60000,1,NoOp(IIAX2 ARFN ${EXTEN})
    same => n,Verbose(3,IAX2 ${EXTEN})
    same => n,Wait(1)
    same => n,Dial(IAX2/${EXTEN},30)
    same => n,Hangup()

exten => 62003,1,NoOp(R62003: Infoway via IAX2)
    same => n,Verbose(3,N8330 via IAX ${EXTEN})
    same => n,Wait(1)
    same => n,Dial(IAX2/${EXTEN},30,m)
    same => n,Hangup()

exten => 62004,1,NoOp(R62004: dv7 via IAX2)
    same => n,Verbose(3,dv7 via IAX2 ${EXTEN})
    same => n,Wait(1)
    same => n,Dial(IAX2/${EXTEN},30,m)
    same => n,Hangup()

exten => 62005,1,NoOp(R62005: 8330 via IAX2)
    same => n,Verbose(3,8330 via IAX2 ${EXTEN})
    same => n,Wait(1)
    same => n,Dial(IAX2/${EXTEN},30,m)
    same => n,Hangup()

exten => 63221,1,NoOp(Ramal 6 3221 Melissa via IAX2)
    same => n,Verbose(3,Me via IAX2 ${EXTEN})
    same => n,Wait(1)
    same => n,Dial(IAX2/${EXTEN},30)
    same => n,Hangup()

exten => 63222,1,NoOp(Ramal 6 3222 Melissa via IAX2)
    same => n,Verbose(3,Me via IAX2 ${EXTEN})
    same => n,Wait(1)
    same => n,Dial(IAX2/${EXTEN},30)
    same => n,Hangup()

exten => 66384,1,NoOp( 66384: ferrari )
    same => n,Verbose(3,Ferrari iPhone via IAX2 ${EXTEN})
    same => n,Wait(1)
    same => n,Dial(IAX2/${EXTEN},30)
    same => n,Hangup()

;========================================================== Ramais Islas
[RamaisISLAS]
;
; Ramais Islas: 1 para torre A 2 para torre B mais o apartamento
;		11A = 111
;		101A = 1101
;		262A = 2262
;
exten => 44,1,NoOp(Zelador)
    same => n,Verbose(3,Zelador ${EXTEN})
    same => n,SayDigits(${EXTEN})
    same => n,Dial(${Islas}/${EXTEN},20)
    same => n,Hangup()
 
; 
; 94 - portaria
;
exten => 94,1,NoOp(Portaria)
    same => n,Verbose(3,Vai ligar na portaria via ${EXTEN})
    same => n,Verbose(3,Vai ligar para ${EXTEN})
    same => n,SayDigits(${EXTEN})
    same => n,Dial(${Islas}/94,20)
    same => n,Hangup()

;
;	130 	salao de festas malhorca
;
exten => 130,1,NoOp(SalaoMalhorca)
    same => n,Verbose(3,Ramal 130 ${EXTEN})
    same => n,SayDigits(${EXTEN})
    same => n,Dial(${Islas}/130,DAHDIDIALTIMEOUT)
    same => n,Hangup()

;
;	140	hall serviço malhorca 1S
;
exten => 140,1,NoOp(Malhorca1S)
    same => n,Verbose(3,Ramal 140 ${EXTEN})
    same => n,SayDigits(${EXTEN})
    same => n,Dial(${Islas}/140,DAHDIDIALTIMEOUT)
    same => n,Hangup()

;
;	150 	hall serviço malhorca 2S
;
exten => 150,1,NoOp(SalaoMallorca)
    same => n,Verbose(3,Ramal 150 ${EXTEN})
    same => n,SayDigits(${EXTEN})
    same => n,Dial(${Islas}/150,DAHDIDIALTIMEOUT)
    same => n,Hangup()

;
;	280 	hall social entrada 2S
;
exten => 280,1,NoOp(EntradaSocial)
    same => n,Verbose(3,Ramal 280 ${EXTEN})
    same => n,SayDigits(${EXTEN})
    same => n,Dial(${Islas}/280,DAHDIDIALTIMEOUT)
    same => n,Hangup()

;
; torre = 1 ou 2 andar de 2 a 9 final = 1 ou 2
;
exten => _[12][2-9][12],1,NoOp(Islas andar 2 a 9)
    same => n,Verbose(3,Ate o nono andar ISLAS)
    same => n,Verbose(3,Vai ligar para ${EXTEN})
    same => n,SayDigits(${EXTEN})
    same => n,Dial(${Islas}/${EXTEN},30)

;
; torre = 1 ou 2 andar de 10 a 19 final = 1 ou 2
;
exten => _[12]1[0-9][12],1,NoOp(Islas andar 10 a 19)
    same => n,Verbose(3,Ate o nono andar ISLAS)
    same => n,Verbose(3,Vai ligar para ${EXTEN})
    same => n,SayDigits(${EXTEN})
    same => n,Dial(${Islas}/${EXTEN},30)

;
; torre = 1 ou 2 andar de 20 a 26 final = 1 ou 2
;
exten => _[12]2[0-6][12],1,NoOp(Islas andar 10 a 19)
    same => n,Verbose(3,Ate o nono andar ISLAS)
    same => n,Verbose(3,Vai ligar para ${EXTEN})
    same => n,SayDigits(${EXTEN})
    same => n,Dial(${Islas}/${EXTEN},30)

;=========================================================== RotaCelular
[RotaCelular]
;
; Rota externa para celulares 9-XXXX-XXXX
;
exten => _9NXXXXXXX,1,Verbose(3,Celular ${EXTEN} )
    same => n,Dial(${PSTN}/${EXTEN},${DAHDIDIALTIMEOUT})
    same => n,Hangup()

;============================================================= RotaLocal
[RotaLocal]
;
; Rota externa para Telefones locais comuns 
;
exten => _NXXXXXXX,1,NoOp(Fixo)
    same => n,Verbose(3,Ligando para ${EXTEN})
    same => n,Dial(${PSTN}/${EXTEN},30)
    same => n,Hangup()

;===================================================== subRamaisInternos
; sub()	arg1	extension
;	arg2	channel
;	arg3	dial timeout
;
[subRamaisInternos]
exten => start,1,NoOp(Ramal ${ARG1})
    same => n,Set(CHANNEL(language)=br)
    same => n,Verbose(3,Chamando Ramal ${ARG1} por ${ARG3}s)
    same => n,Dial(${ARG2},${ARG3})
    same => n,Verbose(3,Discagem falhou. Status = ${DIALSTATUS})
    same => n,VoiceMail(${ARG1}@default,u)
    same => n,Hangup()

;============================================================== TestMenu
[TestMenu]
exten => start,1,NoOp(:Menu de Teste)
    same => n,Verbose(3,Vai atender em TestMenu)
    same => n,Answer()
    same => n,BackGround(main-menu)
    same => n,WaitExten(5)

exten => 1,1,Playback(digits/1)
    same => n,Goto(TestMenu,start,1)

exten => 2,1,Playback(digits/2)
    same => n,Goto(TestMenu,start,1)

exten => i,1,Playback(pbx-invalid)
    same => n,Goto(TestMenu,start,1)

exten => t,1,Playback(vm-goodbye)
    same => n,Goto(TestMenu,start,1)

;
;
; fim de extensions.conf
